# Архитектура аутрич-системы на 1200 email-адресов

**Цель:** обслуживать 1200 адресов для аутрича (несколько клиентов, направлений) при минимальной стоимости инфраструктуры и высокой отказоустойчивости.

## Сервисы и подходы

- **Отправка:** транзакционный email через облачный провайдер (Amazon SES, SendGrid или Mailgun). Собственный MTA не используем — выше операционные затраты и риски блокировок. У провайдера — готовые лимиты, репутация и баунсы.
- **Очереди:** одна очередь задач на отправку (Redis + RQ или AWS SQS). Каждая задача — один письмо или батч по клиенту/направлению. Повторы при временных ошибках с экспоненциальной задержкой.
- **Ротация отправителей:** несколько доменов/подписей (например 3–5), привязанных к одному или разным аккаунтам провайдера. Отправитель выбирается по правилу: round-robin по домену или по лимиту писем в день на домен (например 300–400 на домен при 1200 адресах). Это снижает нагрузку на один домен и изолирует репутацию.
- **Мониторинг:** метрики (отправлено, доставлено, открытия/клики если провайдер отдаёт события, отказы/жалобы). Алерты на падение воркеров, рост ошибок доставки и падение репутации домена. Дашборд (Grafana + Prometheus или облачный мониторинг провайдера).

## Распределение нагрузки

- Нагрузка распределяется через очередь: продюсеры (CRM/скрипты) кладут задачи, воркеры забирают и шлют через API провайдера. Rate limiting на стороне приложения: не более N писем в минуту на домен/аккаунт, чтобы не упираться в лимиты провайдера и не вызывать срабатывание антиспам-фильтров.
- Клиенты/направления разделяются тегами или отдельными очередями (отдельная очередь на клиента или тег в задаче), чтобы можно было ограничивать объём по клиенту и считать метрики по направлениям.

## Ротация и отказоустойчивость

- Ротация: при достижении дневного лимита по домену или при падении репутации домен исключается из пула до проверки; остальные продолжают отправку. Периодическая проверка «здоровья» доменов (bounce rate, жалобы) и автоматическое отключение при пороге.
- Отказоустойчивость: несколько воркеров (хотя бы 2) на отдельном VPS или в облаке; при падении одного второй продолжает обрабатывать очередь. Очередь персистентная (Redis persistence или SQS), чтобы задачи не терялись при рестарте. Провайдер email выбран с SLA и возможностью быстрого переключения на запасной регион/аккаунт при сбое.

## Риски и закрытие

| Риск                                                     | Закрытие                                                                                                                                                  |
| -------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Блокировка домена/IP провайдером или почтовыми серверами | Несколько доменов, лимиты на домен, тёплый ап (постепенное увеличение объёма), подписывание (SPF, DKIM, DMARC), периодическая ротация IP.                 |
| Рост жалоб и падение доставляемости                      | Сегментация по клиентам/направлениям, мониторинг bounce/complaint, отключение «горящих» доменов, использование Double Opt-In и регулярная чистка списков. |
| Лимиты провайдера (throttling)                           | Rate limiting в приложении, несколько аккаунтов/доменов, диалог с поддержкой на повышение лимитов.                                                        |
| Потеря задач при сбое                                    | Персистентная очередь (Redis AOF или SQS), повторные попытки с бэкоффом.                                                                                  |

## Дополнительные аспекты (Tech Lead Level)

- **Профилактика (Warm-up):** Новые домены вводятся в эксплуатацию постепенно (с 10–20 писем в день до целевого объема за 2–4 недели). Это критично для обхода фильтров Gmail/Outlook.
- **Гигиена списков:** Перед отправкой основной кампании обязательна валидация email (как в Задании 1) для минимизации Bounce Rate. Каждые 3–6 месяцев проводится реактивация или удаление неактивных адресов.
- **Масштабируемость:** При росте до 10k+ адресов архитектура позволяет горизонтально масштабировать воркеры и добавлять новые пулы доменов без изменения логики ядра.

## Оценка стоимости (порядок, в месяц)

- **Email-провайдер (SES/SendGrid/Mailgun):** ~$15–40 при объёме до нескольких десятков тысяч писем (включая тесты и повторы).
- **Очередь:** Redis на shared/VPS или SQS — $0–15.
- **Воркеры:** 1–2 VPS (2 GB RAM) или Lambda-подобные воркеры — $10–25.
- **Мониторинг:** бесплатный tier (Grafana Cloud, провайдер) или $0–20.

**Итого:** ориентировочно **$25–100/мес** в зависимости от выбора облака и объёма отправки.
